var glob = require("glob");
var requireNew = require('require-new');
var jsonfile = require('jsonfile');
var fs = require('fs');
var path = require('path');
var firstStart = true;
var pluginsLoaded = [];
var commandHandler = {};
var fChatLibInstance = {};
var channelName = "";
var fileDir;
var fileName;

/*
 * Default commands
 * ---------------------------------------------------------------------------
 */

/* commandHandler.help = function (args, data) {
    var commandsHelp = "";
    var cmdArrSorted = [];
    for(var i in commandHandler){
        if(typeof commandHandler[i] == "function"){
            // commandsHelp += ", !"+i;
            cmdArrSorted.push(i);
        }
    }
    cmdArrSorted.sort();
    for(var i in cmdArrSorted){
        commandsHelp += ", !"+cmdArrSorted[i];
    }
    commandsHelp = commandsHelp.substr(1);
    fChatLibInstance.sendMessage('Here are the available commands:'+commandsHelp, data.channel);
}; */


commandHandler.flood = function (args, data) {
    if(fChatLibInstance.isUserChatOP(data.character, data.channel)){
        fChatLibInstance.sendMessage('Current flood limit set: '+fChatLibInstance.floodLimit, data.channel);
    }
    else{
        fChatLibInstance.sendMessage('You don\'t have sufficient rights.', data.channel);
    }
};

commandHandler.reloadplugins = function (args, data) {
    if(fChatLibInstance.isUserChatOP(data.character, data.channel)){
        fChatLibInstance.softRestart(data.channel);
        fChatLibInstance.sendMessage('All plugins have been reloaded!', data.channel);
    }
    else{
        fChatLibInstance.sendMessage('You don\'t have sufficient rights.', data.channel);
    }
};

commandHandler.greload = function (args, data) {
    if(data.character == fChatLibInstance.config.master){
        for(var i = 0; i < fChatLibInstance.channels.length; i++){
            fChatLibInstance.softRestart(fChatLibInstance.channels[i]);
        }
        fChatLibInstance.sendMessage('All plugins have been reloaded!', data.channel);
    }
    else{
        fChatLibInstance.sendMessage('You don\'t have sufficient rights.', data.channel);
    }
};

commandHandler.grestart = function (args, data) {
    if(fChatLibInstance.isUserChatOP(data.character, data.channel) || data.character == "Kenia Nya"){
        fChatLibInstance.restart();
    }
    else{
        fChatLibInstance.sendMessage('You don\'t have sufficient rights.', data.channel);
    }
};

commandHandler.gdisableinvites = function (args, data) {
    if(data.character == fChatLibInstance.config.master){
        fChatLibInstance.removeInviteListener(fChatLibInstance.joinChannelsWhereInvited);
    }
    else{
        fChatLibInstance.sendMessage('You don\'t have sufficient rights.', data.channel);
    }
};

commandHandler.genableinvites = function (args, data) {
    if(data.character == fChatLibInstance.config.master){
        fChatLibInstance.removeInviteListener(fChatLibInstance.joinChannelsWhereInvited);
        fChatLibInstance.addInviteListener(fChatLibInstance.joinChannelsWhereInvited);
    }
    else{
        fChatLibInstance.sendMessage('You don\'t have sufficient rights.', data.channel);
    }
};

commandHandler.gjoinchannel = function (args, data) {
    if(data.character == fChatLibInstance.config.master){
        fChatLibInstance.joinNewChannel(args);
    }
    else{
        fChatLibInstance.sendMessage('You don\'t have sufficient rights.', data.channel);
    }
};

commandHandler.list = function (args, data) {
    var userList = fChatLibInstance.getUserList(data.channel);
    var str="";
    for(var i in userList){
        str += ", "+userList[i];
    }
    str = str.substr(1);
    fChatLibInstance.sendMessage('Here are the current characters in the room:'+str, data.channel);
};

commandHandler.listops = function (args, data) {
    var chatOPList = fChatLibInstance.getChatOPList(data.channel);
    var str="";
    for(var i in chatOPList){
        str += ", "+chatOPList[i];
    }
    str = str.substr(1);
    fChatLibInstance.sendMessage('Here are the current operators in the room:'+str, data.channel);
};

commandHandler.availableplugins = function (args, data) {
    if(fChatLibInstance.isUserChatOP(data.character, data.channel)){
        fChatLibInstance.sendMessage(listAvailablePlugins(), data.channel);
    }
    else{
        fChatLibInstance.sendMessage('You don\'t have sufficient rights.', data.channel);
    }
};

commandHandler.loadplugin = function (args, data) {
    if(fChatLibInstance.isUserChatOP(data.character, data.channel)){
        if(args == undefined || args == ""){
            fChatLibInstance.sendMessage("Wrong parameter. Example: !loadplugin pluginname\n"+listAvailablePlugins(), data.channel);
        }
        else{
            loadPlugin(args);
        }
    }
    else{
        fChatLibInstance.sendMessage('You don\'t have sufficient rights.', data.channel);
    }
};

commandHandler.loadedplugins = function (args, data) {
    if(fChatLibInstance.isUserChatOP(data.character, data.channel)){
        fChatLibInstance.sendMessage('The following plugins are loaded: '+pluginsLoaded.join(", "), data.channel);
    }
    else{
        fChatLibInstance.sendMessage('You don\'t have sufficient rights.', data.channel);
    }
};

commandHandler.unloadplugin = function (args, data) {
    if(fChatLibInstance.isUserChatOP(data.character, data.channel)){
        unloadPlugin(args);
    }
    else{
        fChatLibInstance.sendMessage('You don\'t have sufficient rights.', data.channel);
    }
};

commandHandler.uptime = function (args, data) {
    fChatLibInstance.sendMessage("The bot has been running for "+getUptime(), data.channel);
};

commandHandler.flushpluginslist = function (args, data) {
    if(fChatLibInstance.isUserChatOP(data.character, data.channel)){
        fChatLibInstance.channels[data.channel].plugins = [];
        fChatLibInstance.sendMessage("Removed all plugins, the bot will restart.");
        fChatLibInstance.softRestart(data.channel);
    }
    else{
        fChatLibInstance.sendMessage('You don\'t have sufficient rights.', data.channel);
    }
};


/*
 * Load external plugins
 * ---------------------------------------------------------------------------
 */
 function loadPlugin(pluginName){
    var files =  glob.sync(process.cwd()+"/plugins/"+pluginName+".js");
    var strAddedCommands = "";

    for (var i = 0; i < files.length; i++) {

        var newHandler = requireNew(files[i])(fChatLibInstance, channelName);

        //lowercase alias
        for(var j = 0; j < Object.keys(newHandler).length; j++){
            strAddedCommands += "!"+Object.keys(newHandler)[j].toLowerCase() + ", ";
            if(Object.keys(newHandler)[j].toLowerCase() != Object.keys(newHandler)[j]){
                newHandler[Object.keys(newHandler)[j].toLowerCase()] = newHandler[Object.keys(newHandler)[j]];
            }
        }
        commandHandler = Object.assign(commandHandler,newHandler);

    };

    strAddedCommands = strAddedCommands.substr(0, strAddedCommands.length - 2);
    if(strAddedCommands == ""){
        fChatLibInstance.sendMessage("There weren't any loaded commands for this plugin. Are you sure it exists?", channelName);
    }
    else{
        fChatLibInstance.sendMessage("The following commands were loaded: "+strAddedCommands, channelName);
        if(pluginsLoaded.indexOf(pluginName) == -1){
            pluginsLoaded.push(pluginName);
            updatePluginsFile();
        }
    }
}

function listAvailablePlugins() {
    var files = glob.sync(process.cwd() + "/plugins/*.js");
    var pluginNames = [];
    files.sort();
    for (var i = 0; i < files.length; i++) {
        pluginNames.push(path.basename(files[i]).replace('.js', ''));
    }
    return 'The following plugins are available: '+pluginNames.join(', ')+'\nIf you want to load all plugins, enter * as the plugin name.';
}

function unloadPlugin(pluginName){
    var files =  glob.sync(process.cwd()+"/plugins/"+pluginName+".js");
    if(pluginsLoaded.indexOf(pluginName) == -1){
        pluginsLoaded.splice(pluginsLoaded.indexOf(pluginName), 1);
        updatePluginsFile();
    }
}

function updatePluginsFile(){
    fChatLibInstance.channels[channelName].plugins = pluginsLoaded;
    fChatLibInstance.updateRoomsConfig(fChatLibInstance.channels);
}


function loadPluginOnStart(pluginsPathArray) {
    var strAddedCommands = "";

    for (var i = 0; i < pluginsPathArray.length; i++) {

        var newHandler = requireNew(pluginsPathArray[i])(fChatLibInstance, channelName);

        //lowercase alias
        for(var j = 0; j < Object.keys(newHandler).length; j++){
            strAddedCommands += "!"+Object.keys(newHandler)[j].toLowerCase() + ", ";
            if(Object.keys(newHandler)[j].toLowerCase() != Object.keys(newHandler)[j]){
                newHandler[Object.keys(newHandler)[j].toLowerCase()] = newHandler[Object.keys(newHandler)[j]];
            }
        }
        commandHandler = Object.assign(commandHandler,newHandler);

    };
}

 function getUptime() {
    var sec_num = parseInt(process.uptime(), 10); // don't forget the second param
    var hours   = Math.floor(sec_num / 3600);
    var minutes = Math.floor((sec_num - (hours * 3600)) / 60);
    var seconds = sec_num - (hours * 3600) - (minutes * 60);

    if (hours   < 10) {hours   = "0"+hours;}
    if (minutes < 10) {minutes = "0"+minutes;}
    if (seconds < 10) {seconds = "0"+seconds;}
    return hours+':'+minutes+':'+seconds;
}


module.exports = function (parent, data, chanName) {

    channelName = chanName;

    fChatLibInstance = parent;

    if(firstStart){
        firstStart = false;
        fileName = process.cwd()+"/config/config.rooms.js";
        jsonfile.readFile(fileName, function(err, rooms){
            if(!err){
                if(rooms[chanName] != undefined && rooms[chanName].plugins != undefined){
                    pluginsLoaded = rooms[chanName].plugins;
                    if(pluginsLoaded.length > 0){
                        var pluginsPaths = [];
                        for(var i = 0; i < pluginsLoaded.length; i++){
                            pluginsPaths.push(process.cwd()+"/plugins/"+pluginsLoaded[i]+".js");
                        }
                        loadPluginOnStart(pluginsPaths);
                    }
                }
            }
        });

    }

    if (data && data.message && data.message.length > 2 && data.message[0] == '!') {

        var opts = {
            command: String(data.message.split(' ')[0]).replace('!', '').trim().toLowerCase(),
            argument: data.message.substring(String(data.message.split(' ')[0]).length).trim()
        };

        if (typeof commandHandler[opts.command] === 'function') {
            commandHandler[opts.command](opts.argument, data);
        } else {
            //not found
        }
    }
};